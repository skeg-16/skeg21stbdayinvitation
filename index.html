<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shawn Kieffer Goyena's 21st Birthday - Invitation</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* Import elegant fonts */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;600&display=swap');
        /* Import an optional script font if desired - uncomment and add class below */
        /* @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap'); */


        /* Define Color Variables and RGBA for easy use */
        :root {
            --gold: #d4af37; /* Original gold */
            --light-gold: #ffd700; /* Brighter gold */
            --rich-gold: #b8860b; /* Darker, richer gold */
            --soft-white: #f0f0f0; /* Soft white for text */
            --dark-bg: #0d0d0d; /* Slightly lighter dark bg */
            --mid-bg: #1a1a1a; /* Mid-tone dark */
            --card-bg: #202020; /* Dark grey for card */
            --gold-rgb: 212, 175, 55; /* For use in rgba() */
            --bg-gradient: radial-gradient(circle at center, #1a1a1a 0%, var(--dark-bg) 60%, #000000 100%);
            --card-gradient: linear-gradient(145deg, #2a2a2a, #101010); /* Slightly darker card gradient */
            --button-gradient: linear-gradient(45deg, var(--rich-gold), var(--gold)); /* Richer button gradient */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px; /* Start with mobile-friendly padding */
            overflow-x: hidden; /* Prevent horizontal scroll */
            overflow-y: auto; /* Allow vertical scroll if needed */
            position: relative;
            visibility: hidden; /* Hide initially to prevent FOUC */
            color: var(--soft-white); /* Use soft white as default text color */
            width: 100%; /* Ensure body takes full width */
        }

         /* Ensure body is visible after DOM load */
        body.loaded { visibility: visible; }


        /* Music Placeholder Style */
         .music-placeholder {
             position: fixed;
             bottom: 10px; /* Mobile-friendly position */
             right: 10px; /* Position on the right */
             z-index: 50;
             background: rgba(0, 0, 0, 0.6); /* Slightly darker semi-transparent background */
             border: 1px solid rgba(var(--gold-rgb), 0.4); /* Slightly stronger border */
             border-radius: 30px;
             padding: 8px 15px;
             display: flex;
             align-items: center;
             cursor: pointer;
             transition: all 0.3s ease;
             backdrop-filter: blur(8px);
             -webkit-backdrop-filter: blur(8px);
             color: var(--gold); /* Gold icon/text color */
             font-size: 1.1rem;
             font-weight: 600;
             user-select: none; /* Prevent text selection */
         }
         .music-placeholder i {
             margin-right: 8px;
         }
         .music-placeholder:hover {
             background: rgba(0, 0, 0, 0.8);
             border-color: rgba(var(--gold-rgb), 0.7);
             color: var(--light-gold);
         }
        /* Style for placeholder when music is disabled or not found */
         .music-placeholder.disabled {
             opacity: 0.5;
             cursor: default;
             pointer-events: none;
         }


        /* Content Wrapper for stages */
        .content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align items to the top */
            min-height: calc(100vh - 20px); /* Adjusted for mobile padding */
            /* max-height: 100vh; Removed max-height to allow scroll */
            overflow-y: auto; /* Allow scrolling */
            padding: 0; /* Let stage handle padding */
            width: 100%;
            max-width: 650px; /* Max width for larger screens */
             display: none; /* Initially hidden */
        }

        /* Custom Scrollbar for content-wrapper (mostly for non-mobile) */
        .content-wrapper::-webkit-scrollbar { width: 8px; }
        .content-wrapper::-webkit-scrollbar-track { background: #333; border-radius: 10px; }
        .content-wrapper::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }
        .content-wrapper::-webkit-scrollbar-thumb:hover { background: var(--light-gold); }


        .stage {
            display: none; /* Controlled by JS */
            animation: fadeInScale 0.8s ease-out forwards;
            max-width: 100%; /* Allow stages to take full wrapper width on mobile */
            width: 100%; /* Ensure it respects max-width */
            padding: 30px 15px; /* Mobile-friendly padding */
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.8);
            background: var(--card-gradient);
            border: 1px solid rgba(var(--gold-rgb), 0.2); /* Softer border */
            border-radius: 20px;
            position: relative;
            flex-shrink: 0;
            flex-grow: 0;
             margin: 10px auto; /* Add vertical margin between potential stages if scrollable */
             box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7), 0 0 30px rgba(var(--gold-rgb), 0.2); /* Enhanced shadow */
        }

         @keyframes fadeInScale {
             from { opacity: 0; transform: scale(0.95) translateY(10px); } /* Adjusted for mobile */
             to { opacity: 1; transform: scale(1) translateY(0); }
         }

         @keyframes fadeIn { /* Keep existing fadeIn */
              from { opacity: 0; }
              to { opacity: 1; }
         }

         /* ADDED: Keyframes for the slideInText animation */
         @keyframes slideInText {
             0% { transform: translateY(20px); opacity: 0; } /* Start slightly lower and invisible */
             100% { transform: translateY(0); opacity: 1; } /* End in place and visible */
         }


        /* Ensure elements *within* stages get their animation delays */
        /* Reset animation-delay to 0 first for direct children of .stage */
        .stage > * {
             animation-delay: 0s !important; /* Override any default animation delay */
         }

        /* Re-apply specific delays to elements needing them within the stage */
        /* Delays are applied relative to when the stage element *becomes visible* */
        /* Main Card Delays */
        .stage#mainCard .crown { animation-delay: 0.3s !important; }
        .stage#mainCard .invitation-intro { animation-delay: 0.6s !important; }
        .stage#mainCard .title { animation-delay: 0.9s !important; }
        .stage#mainCard .description { animation-delay: 1.2s !important; }
        /* --- CELEBRANT NAME DELAY - Ensure this delay gives enough time for the animation to run --- */
        .stage#mainCard .celebrant-name { animation-delay: 1.5s !important; } /* This now triggers the defined slideInText */
        /* --- END CELEBRANT NAME DELAY --- */
        .stage#mainCard .age-highlight { animation-delay: 1.8s !important; }
        .stage#mainCard .details-section { animation-delay: 2.1s !important; }
        .stage#mainCard .details-section .detail-item:nth-child(1) { animation-delay: 0.2s !important; } /* Relative delay within section */
        .stage#mainCard .details-section .detail-item:nth-child(2) { animation-delay: 0.4s !important; }
        .stage#mainCard .details-section .detail-item:nth-child(3) { animation-delay: 0.6s !important; }
        .stage#mainCard .details-section .detail-item:nth-child(4) { animation-delay: 0.8s !important; }
        .stage#mainCard .next-btn { animation-delay: 3s !important; } /* Button delay after details */

        /* RSVP Section specific delays */
        .stage#rsvpSection .rsvp-title { animation-delay: 0.3s !important; }
        .stage#rsvpSection .rsvp-message { animation-delay: 0.6s !important; }
        .stage#rsvpSection .rsvp-importance-note { animation-delay: 0.9s !important; } /* New element delay */
        .stage#rsvpSection .rsvp-format-example { animation-delay: 1.2s !important; } /* New element delay */
        /* Delays for elements *within* rsvp-format-example */
        .stage#rsvpSection .rsvp-format-example .format-label { animation-delay: 0.2s !important; } /* Relative to parent */
        .stage#rsvpSection .rsvp-format-example .format-text { animation-delay: 0.4s !important; } /* Relative to parent */

        .stage#rsvpSection .rsvp-contact { animation-delay: 1.8s !important; } /* Adjusted delay */
        /* Delays for elements *within* rsvp-contact */
        .stage#rsvpSection .rsvp-contact .contact-label:nth-of-type(1) { animation-delay: 0.2s !important; } /* Relative to parent */
        .stage#rsvpSection .rsvp-contact .contact-name { animation-delay: 0.4s !important; }
        .stage#rsvpSection .rsvp-contact .contact-label:nth-of-type(2) { animation-delay: 0.6s !important; }
        .stage#rsvpSection .rsvp-contact .contact-number { animation-delay: 0.8s !important; }

        .stage#rsvpSection .next-btn { animation-delay: 2.5s !important; } /* Adjusted delay for button */


        /* Thank You Stage specific delays */
         .stage#thankYouSection .thank-you-title { animation-delay: 0.5s !important; }
         .stage#thankYouSection .thank-you-message { animation-delay: 0.8s !important; }
         .stage#thankYouSection .see-you-message { animation-delay: 1.1s !important; }


         /* Keyframes for fading out */
        @keyframes fadeOut {
             from { opacity: 1; transform: scale(1); }
             to { opacity: 0; transform: scale(0.98); } /* Adjusted for mobile feel */
         }
         .fade-out {
             animation: fadeOut 0.5s ease-out forwards;
         }


        /* Back button */
        .back-btn {
            position: fixed;
            top: 10px; /* Mobile-friendly position */
            left: 10px; /* Mobile-friendly position */
            background: rgba(var(--gold-rgb), 0.15); /* Slightly more visible background */
            color: var(--gold);
            border: 1px solid rgba(var(--gold-rgb), 0.5); /* Slightly stronger border */
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 50;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            font-weight: 600;
            user-select: none;
        }

        .back-btn.hidden {
             display: none !important;
         }


        /* Floating particles background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden; /* Ensure particles don't cause scrollbars */
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--light-gold);
            border-radius: 50%;
            animation: float 8s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.5; } /* Softer entry */
            90% { opacity: 0.5; } /* Stay opaque longer */
            100% { transform: translateY(-10vh) rotate(360deg); opacity: 0; }
        }

        /* Click/tap sparkle effect */
        .click-sparkle {
            position: fixed; /* Use fixed so it's relative to viewport */
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, white 0%, var(--light-gold) 50%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 998;
            animation: sparkleFadeOut 0.8s ease-out forwards;
            transform-origin: center;
        }

        @keyframes sparkleFadeOut {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        /* Shimmer effect for titles */
         .shimmering {
            position: relative;
            overflow: hidden;
            display: inline-block; /* Allows shimmer to size to text */
            vertical-align: middle;
            z-index: 0; /* Ensure shimmer is above background, below text */
        }

        .shimmering .shimmer-after {
            display: block;
            position: absolute;
            top: 0;
            left: -200%;
            width: 200%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            animation: shimmer 4s infinite cubic-bezier(0.25, 0.1, 0.25, 1);
            z-index: 1;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% { left: -200%; }
            100% { left: 200%; }
        }


        /* Stage 1: Envelope */
        .envelope-container {
            position: relative;
            width: 90%; /* Use percentage for mobile */
            max-width: 320px; /* Max width for larger screens */
            height: 220px; /* Adjusted height */
            cursor: pointer;
            z-index: 10;
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            animation: pulse-float 3s infinite ease-in-out;
        }
         @keyframes pulse-float {
             0%, 100% { transform: translateY(0); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 0 0 20px rgba(var(--gold-rgb), 0.3); }
             50% { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 0 0 30px rgba(var(--gold-rgb), 0.5); } /* Adjusted float height/shadow for mobile */
         }


        .envelope {
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, var(--card-bg), var(--mid-bg));
            border: 2px solid var(--gold);
            border-radius: 10px;
            position: relative;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        /* Envelope flap triangles - adjusted relative to container width */
        .envelope::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            /* Border size relative to max-width or width? This is tricky. Let's refine slightly. */
            /* Adjusted border sizes - roughly 160px base, scales implicitly with container width */
             border-left: calc(min(320px, 90vw) / 2) solid transparent; /* Base ~160px */
             border-right: calc(min(320px, 90vw) / 2) solid transparent; /* Base ~160px */
             border-top: calc(min(320px, 90vw) / 2 * 0.6875) solid var(--gold); /* Base ~110px (110/160 = 0.6875) */
            z-index: 2;
        }

        .envelope::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
             /* Adjusted border sizes - relative to container width */
             border-left: calc(min(320px, 90vw) / 2 - 5px) solid transparent; /* Base ~155px */
             border-right: calc(min(320px, 90vw) / 2 - 5px) solid transparent; /* Base ~155px */
             border-top: calc(min(320px, 90vw) / 2 * 0.6875 - 5px) solid var(--mid-bg); /* Base ~105px */
            z-index: 3;
        }

        .envelope-seal {
            position: absolute;
            top: 40px; /* Adjusted position */
            left: 50%;
            transform: translateX(-50%);
            width: 50px; /* Adjusted size */
            height: 50px; /* Adjusted size */
            background: radial-gradient(circle, var(--light-gold), var(--gold));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem; /* Adjusted font size */
            z-index: 4;
            box-shadow: 0 5px 15px rgba(var(--gold-rgb), 0.5);
            animation: seal-bounce 1s ease-out forwards;
             animation-delay: 0.5s;
             opacity: 0;
        }

        @keyframes seal-bounce {
             0% { transform: translateX(-50%) scale(0.8); opacity: 0; }
             50% { transform: translateX(-50%) scale(1.1); opacity: 1; }
             70% { transform: translateX(-50%) scale(0.9); }
             100% { transform: translateX(-50%) scale(1); opacity: 1;}
        }


        .envelope-text {
            position: absolute;
            bottom: 30px; /* Adjusted position */
            left: 50%;
            transform: translateX(-50%);
            color: var(--gold);
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem; /* Adjusted font size */
            text-align: center;
            z-index: 2;
            width: 100%;
            padding: 0 10px;
             animation: text-slide-in 1s ease-out forwards;
             opacity: 0;
             animation-delay: 1s;
        }

        @keyframes text-slide-in {
             from { transform: translateX(-50%) translateY(10px); opacity: 0; } /* Adjusted movement */
             to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Optional: Adjust envelope triangles slightly for desktop if needed */
        @media (min-width: 769px) {
            .envelope-container { width: 400px; height: 280px; }
            .envelope::before {
                 border-left: 200px solid transparent;
                 border-right: 200px solid transparent;
                 border-top: 140px solid var(--gold);
            }
            .envelope::after {
                 border-left: 195px solid transparent;
                 border-right: 195px solid transparent;
                 border-top: 135px solid var(--mid-bg);
            }
            .envelope-seal { top: 50px; width: 60px; height: 60px; font-size: 2rem; }
            .envelope-text { bottom: 60px; font-size: 1.2rem;}
             @keyframes pulse-float { 0%, 100% { transform: translateY(0); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 0 0 20px rgba(var(--gold-rgb), 0.3); } 50% { transform: translateY(-10px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 0 0 40px rgba(var(--gold-rgb), 0.6); } }
        }


        /* Stage 2: Main Invitation */
         #mainCard { text-align: center; }

         .crown {
            font-size: 3.5rem; /* Mobile font size */
            margin-bottom: 10px; /* Adjusted margin */
            animation: crownSpin 4s infinite; /* Existing animation */
            display: block;
            margin-left: auto;
            margin-right: auto;
            color: var(--light-gold);
             animation: fadeIn 1s ease-out forwards; /* Fade in */
             opacity: 0;
        }
         @media (min-width: 769px) { .crown { font-size: 4.5rem; margin-bottom: 15px;} }


         .invitation-intro {
             font-family: 'Playfair Display', serif; /* Or 'Great Vibes', cursive; if imported */
             font-style: italic;
             font-size: 1.4rem; /* Mobile font size */
             color: var(--soft-white); /* Soft white */
             margin-bottom: 8px; /* Space between intro and title */
             text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
             animation: fadeIn 1s ease-out forwards; /* Fade in */
             opacity: 0; /* Starts invisible for animation */
         }
          @media (min-width: 769px) { .invitation-intro { font-size: 1.8rem; margin-bottom: 10px; } }


        .title {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem; /* Mobile font size */
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 8px; /* Adjusted margin */
            text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.8);
            animation: textGlow 2.5s infinite alternate, fadeIn 1s ease-out forwards; /* Add fade in */
            opacity: 0;
        }
         @media (min-width: 769px) { .title { font-size: 3.5rem; margin-bottom: 10px; } }


        .description { /* Changed from p to class for clarity */
             color: var(--soft-white);
             font-style: italic;
             margin-bottom: 15px; /* Adjusted margin */
             animation: fadeIn 1s ease-out forwards; /* Fade in */
             opacity: 0;
             text-align: center;
             text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
             font-size: 1rem; /* Mobile font size */
         }
         @media (min-width: 769px) { .description { font-size: 1.1rem; margin-bottom: 20px; } }


        .celebrant-name {
            font-family: 'Playfair Display', serif;
            font-size: 2rem; /* Mobile font size */
            font-weight: 700;
            color: var(--soft-white); /* Soft white */
            margin-bottom: 20px; /* Adjusted margin */
            letter-spacing: 2px; /* Adjusted letter spacing */
            /* Now uses the defined slideInText keyframes */
            animation: slideInText 1.5s ease-out forwards; /* Animation is applied here */
            opacity: 0; /* Starts hidden - THE ANIMATION WILL CHANGE THIS */
            animation-fill-mode: forwards; /* Stays visible after animation */
             text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
         @media (min-width: 769px) { .celebrant-name { font-size: 2.8rem; letter-spacing: 4px; margin-bottom: 30px; } }


        .age-highlight {
            font-family: 'Playfair Display', serif;
            font-size: 4.5rem; /* Mobile font size */
            font-weight: 700;
            color: var(--gold);
            margin: 30px 0; /* Adjusted margin */
            animation: ageGlow 2.5s infinite, bounceIn 1s ease-out forwards; /* Existing animations */
            opacity: 0;
            animation-fill-mode: forwards;
             text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.8);
        }
         @keyframes ageGlow { /* Ensure consistent mobile keyframe if needed, otherwise keep base */
              0%, 100% { transform: scale(1) rotate(0deg); text-shadow: 0 0 20px rgba(var(--gold-rgb), 0.5); }
              50% { transform: scale(1.05) rotate(-1deg); text-shadow: 0 0 30px rgba(var(--gold-rgb), 0.8); } /* Slightly reduced scale/shadow for mobile feel */
         }
          @media (min-width: 769px) { .age-highlight { font-size: 6rem; margin: 40px 0; }
             @keyframes ageGlow { /* Restore larger animation for desktop */
                 0%, 100% { transform: scale(1) rotate(0deg); text-shadow: 0 0 20px rgba(var(--gold-rgb), 0.5); }
                 50% { transform: scale(1.1) rotate(-2deg); text-shadow: 0 0 40px rgba(var(--gold-rgb), 1); }
             }
         }
         @keyframes bounceIn { /* Keep existing bounceIn */
              0% { transform: scale(0.3); opacity: 0; }
              50% { transform: scale(1.05); opacity: 1; }
              70% { transform: scale(0.9); }
              100% { transform: scale(1); opacity: 1; }
         }


        .details-section {
            margin: 30px 0; /* Adjusted margin */
            padding: 25px; /* Adjusted padding */
            background: rgba(0, 0, 0, 0.5); /* Keep semi-transparent background */
            border-radius: 20px;
            border: 1px solid rgba(var(--gold-rgb), 0.3); /* Softer border */
             text-align: center;
             opacity: 0; /* Start invisible for animation */
             animation: fadeIn 1s ease-out forwards; /* Animation for the section itself */
             width: 100%; /* Ensure it takes full width within the card */
        }
         @media (min-width: 769px) { .details-section { margin: 50px 0; padding: 40px; } }


        .detail-item {
            margin: 20px 0; /* Adjusted margin */
            color: var(--soft-white); /* Use soft white */
            font-size: 1.1rem; /* Mobile font size */
            animation: detailFadeIn 0.8s ease-out forwards; /* Existing animation */
            opacity: 0; /* Starts invisible for animation */
        }
         @media (min-width: 769px) { .detail-item { margin: 25px 0; font-size: 1.3rem; } }


        @keyframes detailFadeIn {
             from { opacity: 0; transform: translateY(10px);} /* Add slight movement */
             to { opacity: 1; transform: translateY(0);}
         }


        .detail-label {
            color: var(--light-gold);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px; /* Adjusted letter spacing */
            margin-bottom: 5px; /* Adjusted margin */
            display: block;
            font-size: 0.9rem; /* Mobile font size */
        }
         @media (min-width: 769px) { .detail-label { font-size: 1rem; letter-spacing: 1.5px; margin-bottom: 8px; } }


        .detail-value {
            font-weight: 400; /* Standard weight for values */
             word-break: break-word; /* Prevent long words/addresses from overflowing */
             font-size: 1rem; /* Mobile font size */
        }
        @media (min-width: 769px) { .detail-value { font-size: 1.1rem; } }


        .next-btn {
            background: var(--button-gradient);
            color: #000; /* Black text on gold button */
            border: none;
            padding: 12px 30px; /* Adjusted padding */
            font-size: 1.1rem; /* Adjusted font size */
            font-weight: 600; /* Adjusted font weight */
            border-radius: 30px; /* Adjusted border radius */
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-top: 25px; /* Adjusted margin */
            animation: buttonPulse 2s infinite, fadeIn 1s ease-out forwards; /* Existing animations */
            opacity: 0;
            position: relative;
            overflow: hidden;
            z-index: 2;
             display: block;
            margin-left: auto;
            margin-right: auto;
             box-shadow: 0 5px 15px rgba(var(--gold-rgb), 0.3);
             max-width: 80%; /* Prevent button from being too wide on small screens */
        }
         @keyframes buttonPulse { /* Keep existing pulse */
             0%, 100% { transform: scale(1); box-shadow: 0 5px 15px rgba(var(--gold-rgb), 0.3); }
             50% { transform: scale(1.03); box-shadow: 0 5px 20px rgba(var(--gold-rgb), 0.5); } /* Slightly reduced pulse for mobile */
        }
         @media (min-width: 769px) { .next-btn { padding: 15px 50px; font-size: 1.3rem; font-weight: 700; border-radius: 35px; margin-top: 30px; max-width: none; }
             @keyframes buttonPulse { /* Restore larger pulse for desktop */
                 0%, 100% { transform: scale(1); box-shadow: 0 5px 15px rgba(var(--gold-rgb), 0.3); }
                 50% { transform: scale(1.05); box-shadow: 0 5px 25px rgba(var(--gold-rgb), 0.6); }
             }
         }


        .next-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            transition: left 0.4s ease-in-out;
            z-index: -1;
        }
        .next-btn:hover::before { left: 100%; }


        /* Stage 3: RSVP */
        #rsvpSection { text-align: center; } /* Center align contents */

        .rsvp-title {
            font-family: 'Playfair Display', serif;
            font-size: 3rem; /* Mobile size */
            color: var(--light-gold);
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            animation: fadeIn 1s ease-out forwards; /* Simple fade in */
            opacity: 0;
        }
        @media (min-width: 769px) { .rsvp-title { font-size: 4rem; margin-bottom: 25px; } }


        .rsvp-message {
            color: var(--soft-white);
            font-size: 1.1rem; /* Mobile size */
            margin-bottom: 15px; /* Reduced margin to make space for new text */
            line-height: 1.6;
            animation: fadeIn 1s ease-out forwards; /* Fade in */
            opacity: 0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        @media (min-width: 769px) { .rsvp-message { font-size: 1.3rem; margin-bottom: 20px; } } /* Adjusted margin */

        .rsvp-importance-note {
            color: var(--gold); /* Highlight importance */
            font-size: 0.95rem; /* Slightly smaller */
            margin-bottom: 20px;
            font-style: italic;
             animation: fadeIn 0.8s ease-out forwards; /* Fade in */
             opacity: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
         @media (min-width: 769px) { .rsvp-importance-note { font-size: 1.1rem; margin-bottom: 30px; } }


        .rsvp-format-example {
            margin: 20px auto;
            padding: 15px;
            background: rgba(var(--gold-rgb), 0.08); /* Very subtle background */
            border-left: 3px solid var(--gold); /* Accent border */
            border-radius: 5px;
            max-width: 90%; /* Make it slightly narrower than the card */
            text-align: left; /* Left align the example */
             animation: fadeIn 0.8s ease-out forwards; /* Fade in */
             opacity: 0;
        }
         @media (min-width: 769px) { .rsvp-format-example { margin: 25px auto; padding: 20px; max-width: 80%;} }

        .format-label {
            display: block;
            color: var(--light-gold);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 5px;
             animation: fadeIn 0.6s ease-out forwards; /* Added animation */
             opacity: 0;
             animation-fill-mode: forwards;
        }

        .format-text {
            font-family: 'Montserrat', sans-serif; /* Use a readable font */
            font-style: normal; /* Not italic by default */
            color: var(--soft-white);
            font-size: 1rem; /* Mobile size */
            line-height: 1.5;
             animation: fadeIn 0.6s ease-out forwards; /* Added animation */
             opacity: 0;
             animation-fill-mode: forwards;
        }
        @media (min-width: 769px) { .format-text { font-size: 1.1rem; } }


        .rsvp-contact {
            margin: 30px auto;
            padding: 20px; /* Add padding */
            background: rgba(0, 0, 0, 0.4); /* Darker background for contrast */
            border-radius: 15px;
            border: 1px solid rgba(var(--gold-rgb), 0.3);
            max-width: 300px; /* Limit contact block width */
            animation: fadeIn 1s ease-out forwards; /* Animation for the block */
            opacity: 0;
        }
         @media (min-width: 769px) { .rsvp-contact { padding: 30px; max-width: 350px; } }


        .contact-label {
            color: var(--gold);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-size: 0.85rem; /* Mobile size */
            margin-bottom: 5px;
            animation: fadeIn 0.6s ease-out forwards; /* Add fadeIn animation */
            opacity: 0;
             animation-fill-mode: forwards;
        }
        @media (min-width: 769px) { .contact-label { font-size: 0.9rem; margin-bottom: 8px; letter-spacing: 1px; } }


        .contact-name {
            color: var(--soft-white);
            font-size: 1.3rem; /* Mobile size */
            font-weight: 700; /* Bold name */
            margin-bottom: 15px;
            animation: fadeIn 0.6s ease-out forwards; /* Add fadeIn animation */
            opacity: 0;
             animation-fill-mode: forwards;
        }
        @media (min-width: 769px) { .contact-name { font-size: 1.5rem; margin-bottom: 20px; } }


        .contact-number {
            color: var(--soft-white);
            font-size: 1.2rem; /* Mobile size */
            font-weight: 400;
            animation: fadeIn 0.6s ease-out forwards; /* Add fadeIn animation */
            opacity: 0;
             animation-fill-mode: forwards;
        }
        @media (min-width: 769px) { .contact-number { font-size: 1.4rem; } }

        .phone-link {
            color: var(--soft-white); /* Same color as text */
            text-decoration: none; /* Remove underline */
            transition: color 0.3s ease;
        }
        .phone-link:hover {
            color: var(--light-gold); /* Change color on hover */
            text-decoration: underline; /* Add underline on hover */
        }


        /* Stage 4: Thank You (Adjusted from Stage 3 to Stage 4) */
        #thankYouSection { text-align: center; }

        .thank-you-title {
            font-family: 'Playfair Display', serif;
            font-size: 3rem; /* Mobile font size */
            color: var(--light-gold);
            margin-bottom: 20px; /* Adjusted margin */
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            animation: textGlow 2s infinite alternate, rubberBand 1s ease-out forwards; /* Keep rubberBand */
            opacity: 0;
        }
        @media (min-width: 769px) { .thank-you-title { font-size: 4rem; margin-bottom: 25px; } }

         @keyframes rubberBand { /* Keep existing rubberBand */
              0% { transform: scale3d(1, 1, 1); opacity: 0; }
              30% { transform: scale3d(1.25, 0.75, 1); opacity: 1; }
              40% { transform: scale3d(0.75, 1.25, 1); }
              50% { transform: scale3d(1.15, 0.85, 1); }
              65% { transform: scale3d(.95, 1.05, 1); }
              75% { transform: scale3d(1.05, .95, 1); }
              100% { transform: scale3d(1, 1, 1); opacity: 1; }
         }


        .thank-you-message {
            color: var(--soft-white); /* Use soft white */
            font-size: 1.1rem; /* Mobile font size */
            margin-bottom: 30px; /* Adjusted margin */
            line-height: 1.6;
            animation: fadeIn 1s ease-out forwards; /* Fade in */
            opacity: 0;
             text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
         @media (min-width: 769px) { .thank-you-message { font-size: 1.5rem; margin-bottom: 50px; } }


        .see-you-message {
            font-family: 'Playfair Display', serif;
            font-size: 2rem; /* Mobile font size */
            color: var(--gold);
            font-weight: 700;
            animation: pulse-glow 2s infinite, fadeIn 1s ease-out forwards; /* Existing animations */
            opacity: 0;
             text-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
         @media (min-width: 769px) { .see-you-message { font-size: 2.5rem; } }


         @keyframes pulse-glow { /* Keep existing pulse-glow */
              0%, 100% { text-shadow: 2px 2px 5px rgba(0,0,0,0.5), 0 0 10px rgba(var(--gold-rgb), 0.3); }
              50% { text-shadow: 2px 2px 5px rgba(0,0,0,0.5), 0 0 20px rgba(var(--gold-rgb), 0.5); } /* Slightly reduced glow for mobile */
         }
         @media (min-width: 769px) {
            @keyframes pulse-glow { /* Restore larger glow for desktop */
                 0%, 100% { text-shadow: 2px 2px 5px rgba(0,0,0,0.5), 0 0 10px rgba(var(--gold-rgb), 0.3); }
                 50% { text-shadow: 2px 2px 5px rgba(0,0,0,0.5), 0 0 25px rgba(var(--gold-rgb), 0.6); }
            }
         }


        /* Fireworks effect */
        .firework {
            position: fixed;
            width: 6px;
            height: 6px;
            background: var(--gold);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1001;
            transform-origin: center;
            animation: fireworkExplode 1.2s ease-out forwards;
        }

        @keyframes fireworkExplode {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(25); opacity: 0; }
        }

        /* Confetti Effect */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            opacity: 0.9;
            pointer-events: none;
            z-index: 999;
             /* Background color set by JS */
        }

        @keyframes confettiFall {
             0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; }
             100% { transform: translateY(105vh) rotateZ(720deg); opacity: 0; }
         }

        @keyframes confettiSideways {
             0% { transform: translateX(0); }
             100% { transform: translateX(var(--confetti-end-x, 0vw)); }
         }


        .hidden { display: none !important; }

        /* Media query for larger screens (desktop-like) */
        @media (min-width: 769px) {
            body { padding: 20px; }
            .content-wrapper {
                min-height: calc(100vh - 40px);
                /* max-height: 100vh; */ /* Re-enable if you want to limit height on desktop */
                padding: 0; /* Reset padding if content-wrapper should fill parent */
                justify-content: center; /* Center vertically on desktop */
            }
            .stage { padding: 40px; margin: 20px auto; max-width: 600px; } /* Restore larger padding and margin */
             @keyframes fadeInScale { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
             @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
             .music-placeholder { bottom: 20px; right: 20px; padding: 8px 15px; font-size: 1.1rem; }
             .back-btn { top: 20px; left: 20px; }

             /* Desktop RSVP Adjustments */
             .rsvp-message { margin-bottom: 20px; font-size: 1.3rem;} /* Re-adjusted margin */
             .rsvp-importance-note { font-size: 1.1rem; margin-bottom: 25px; } /* Adjusted margin */
             .rsvp-format-example { margin: 25px auto; padding: 20px; max-width: 80%;}
             .format-label { font-size: 0.9rem; }
             .format-text { font-size: 1.1rem; }

             .rsvp-contact { padding: 30px; max-width: 350px; }
             .contact-label { font-size: 0.9rem; margin-bottom: 8px; letter-spacing: 1px; }
             .contact-name { font-size: 1.5rem; margin-bottom: 20px; }
             .contact-number { font-size: 1.4rem; }

        }
    </style>
</head>
<body class="loaded">
    <!-- Background Music Element -->
    <!-- IMPORTANT: Replace the src below with the actual path to YOUR music file
         hosted in your GitHub repo (e.g., './music/insomnia.mp3').
         Autoplay is blocked by browsers, but this will attempt to play on the first user click (opening the envelope).
         Provide a user control (the music placeholder div) as a fallback.
    -->
    <audio id="backgroundMusic" src="./Craig David - Insomnia (Lyrics).mp3" loop preload="auto" volume="0.3"></audio>

     <!-- Music Placeholder/Control -->
     <!-- We use a div to style, and link it to the audio element via JS -->
     <div class="music-placeholder" id="musicPlaceholder">
         <i class="fas fa-play"></i> <!-- Start with play icon -->
         <span id="musicStatusText">Play Music</span> <!-- Status text -->
     </div>


    <!-- Back Button -->
    <!-- Add the 'hidden' class initially in HTML as well -->
    <button class="back-btn hidden" id="backButton" onclick="goBack()">< Back</button>

    <!-- Floating particles -->
    <div class="particles" id="particles"></div>

    <!-- Stage 1: Envelope - Shows "You're Invited" and the seal -->
    <div class="envelope-container" id="envelope" onclick="openEnvelope()">
        <div class="envelope">
            <div class="envelope-seal">ðŸ‘‘</div>
            <div class="envelope-text">
                <div style="font-weight: bold;">You're Invited!</div>
                <div style="font-size: 0.9rem; margin-top: 5px;">Click to Open</div>
            </div>
        </div>
    </div>

    <!-- Content Wrapper for other stages -->
    <div class="content-wrapper" id="contentWrapper">
        <!-- Stage 2: Main Invitation - Shows full details -->
        <div class="invitation-card stage" id="mainCard">
            <div class="crown">ðŸ‘‘</div>
            <div class="invitation-intro">You are invited to the...</div>
            <h1 class="title" id="mainTitle">21ST BIRTHDAY CELEBRATION</h1>
            <p class="description">OF</p>
            <!-- CELEBRANT NAME IS HERE AND ANIMATES IN VIA CSS/JS ANIMATION-DELAY -->
            <!-- The `slideInText` animation definition has been added to the CSS -->
            <h2 class="celebrant-name">SHAWN KIEFFER GOYENA</h2>
           

            <!-- Birthday Details Section -->
            <div class="details-section">
                <div class="detail-item">
                    <span class="detail-label">When</span>
                    <div class="detail-value">June 14, 2025 â€¢ 1:00 PM - 6:00 PM</div>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Where</span>
                    <div class="detail-value">KW Party, Pasay City<br>Near Parqal</div>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Room Number</span>
                    <div class="detail-value">K99</div>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Dress Code</span>
                    <div class="detail-value">Casual Attire with Black Top</div>
                </div>
            </div>

            <!-- Button now goes to the RSVP stage -->
            <button class="next-btn" onclick="showRsvp()">Proceed to RSVP</button>
        </div>

        <!-- Stage 3: RSVP -->
        <div class="rsvp-section stage" id="rsvpSection">
            <h2 class="rsvp-title">Please RSVP</h2>
            <p class="rsvp-message">
                Kindly let us know if you can make it.
            </p>
            <p class="rsvp-importance-note">Your confirmation is important for our guest count and reservation details.</p>

            <!-- Suggested Message Format -->
            <div class="rsvp-format-example">
                <p class="format-label">Suggested message format:</p>
                <!-- Added 'blabla' as requested, though it might be better to keep it simple -->
                <p class="format-text">"Hello! I [Your Name/s] will be attending Shawn's 21st birthday!"</p>
            </div>

            <div class="rsvp-contact">
                <p class="contact-label">Contact Person:</p>
                <p class="contact-name">Cheryl Goyena</p>
                <p class="contact-label" style="margin-top: 15px;">Phone Number:</p>
                <p class="contact-number">
                     <!-- Using tel: link makes it clickable on mobile -->
                     <a href="tel:+639946370600" class="phone-link">09946370600</a>
                </p>
            </div>
            <!-- Button goes to the Thank You stage -->
            <button class="next-btn" onclick="showThankYou()">View Final Message</button>
        </div>


        <!-- Stage 4: Thank You (Adjusted from Stage 3 to Stage 4) -->
        <div class="thank-you-section stage" id="thankYouSection">
            <!-- Shimmer class added via JS -->
            <h2 class="thank-you-title" id="thankYouTitle">THANK YOU!</h2>
            <p class="thank-you-message">
                Your presence at Shawn's 21st birthday celebration is the greatest gift of all. We can't wait to share this special milestone with you.
            </p>
            <p class="see-you-message">
                See You There! ðŸ¥³
            </p>
        </div>
    </div> <!-- End content-wrapper -->

    <script>
        let currentStage = 'envelope';
        const envelopeEl = document.getElementById('envelope');
        const contentWrapperEl = document.getElementById('contentWrapper');
        const mainCardEl = document.getElementById('mainCard');
        const rsvpSectionEl = document.getElementById('rsvpSection'); // Get the new RSVP section element
        const thankYouSectionEl = document.getElementById('thankYouSection');
        const backButtonEl = document.getElementById('backButton');
        const backgroundMusic = document.getElementById('backgroundMusic');
        const musicPlaceholderEl = document.getElementById('musicPlaceholder'); // Get the placeholder element
        const musicStatusTextEl = document.getElementById('musicStatusText'); // Get status text
        const mainTitleEl = document.getElementById('mainTitle'); // Main title reference
        const thankYouTitleEl = document.getElementById('thankYouTitle'); // Thank you title reference


        // --- Music Placeholder Logic ---
        let isMusicPlaying = false;
        // Check if music source is valid (not the placeholder path or empty)
        const isMusicSourceValid = backgroundMusic && backgroundMusic.src &&
                                   !backgroundMusic.src.endsWith('./path/to/your/music.mp3') && // Updated placeholder check
                                   backgroundMusic.src !== location.href; // Check against current URL too

        if (musicPlaceholderEl && backgroundMusic) {
             if (!isMusicSourceValid) {
                 // If no valid music source is set, disable the music control
                 musicStatusTextEl.textContent = 'No Music File';
                 musicPlaceholderEl.classList.add('disabled');
                 console.warn("Music source is not set or is default. Music functionality disabled.");
             } else {
                 musicStatusTextEl.textContent = 'Play Music'; // Default text
                 musicPlaceholderEl.classList.remove('disabled');

                 // Handle click on placeholder
                 musicPlaceholderEl.addEventListener('click', () => {
                     if (isMusicPlaying) {
                         backgroundMusic.pause();
                     } else {
                         // Request play, handle potential auto-play blocks
                         const playPromise = backgroundMusic.play();
                         if (playPromise !== undefined) {
                             playPromise.catch(error => {
                                 console.warn("Music play prevented:", error);
                                 // Optionally update UI to inform the user
                                 musicStatusTextEl.textContent = 'Tap to Play'; // Or similar
                             });
                         }
                     }
                 });

                 // Update icon/text when music state changes
                 backgroundMusic.addEventListener('play', () => {
                     isMusicPlaying = true;
                     musicPlaceholderEl.querySelector('i').className = 'fas fa-pause';
                     musicStatusTextEl.textContent = 'Pause Music';
                 });

                 backgroundMusic.addEventListener('pause', () => {
                     isMusicPlaying = false;
                     musicPlaceholderEl.querySelector('i').className = 'fas fa-play';
                     musicStatusTextEl.textContent = 'Play Music';
                 });

                 // Set initial volume
                 backgroundMusic.volume = 0.3;
             }
        } else if (musicPlaceholderEl) {
            // If music tag is missing but placeholder exists
             musicStatusTextEl.textContent = 'Music Error';
             musicPlaceholderEl.classList.add('disabled');
             console.error("Audio element with ID 'backgroundMusic' not found.");
        }


        // Add event listener for body click/tap for sparkles
        document.body.addEventListener('click', createClickSparkle);
        // Use touchstart for touch devices
        document.body.addEventListener('touchstart', createClickSparkle);

        // Function to create click/tap sparkles
        function createClickSparkle(e) {
            // Prevent multiple sparkles on touch events if both click and touchstart are active
             // Added a check for buttons/interactive elements to avoid sparkles there
            if (e.target.closest('button, .music-placeholder, a, input')) {
                 // If the click was on an interactive element, don't show sparkle on the body
                 return;
            }
            if (e.type === 'touchstart') {
                document.body.removeEventListener('click', createClickSparkle);
            }

            const sparkle = document.createElement('div');
            sparkle.className = 'click-sparkle';
            // Use clientX/Y for mouse, touches[0].clientX/Y for touch
            const x = e.clientX || (e.touches && e.touches[0].clientX);
            const y = e.clientY || (e.touches && e.touches[0].clientY);

            if (x === undefined || y === undefined) return; // Exit if coordinates aren't available

            sparkle.style.left = (x - 5) + 'px'; // Center the sparkle
            sparkle.style.top = (y - 5) + 'px';

            document.body.appendChild(sparkle);

            // Clean up sparkle after animation
            setTimeout(() => {
                if (document.body.contains(sparkle)) {
                    sparkle.remove();
                }
            }, 800); // Matches sparkleFadeOut animation duration
        }

        // Create floating particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            const numParticles = window.innerWidth < 768 ? 50 : 80; // Fewer particles on mobile
            for (let i = 0; i < numParticles; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 10 + 's';
                particle.style.animationDuration = (Math.random() * 5 + 5) + 's';
                const size = Math.random() * 2 + 2; // Smaller particles on mobile
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particlesContainer.appendChild(particle);
            }
        }

        // Create fireworks effect
        function createFireworks() {
            const numFireworks = window.innerWidth < 768 ? 20 : 30; // Fewer fireworks on mobile
            for (let i = 0; i < numFireworks; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    // Spawn fireworks a bit higher on mobile
                    firework.style.left = (Math.random() * 80 + 10) + 'vw';
                    firework.style.top = (Math.random() * 30 + 10) + 'vh'; // Adjusted vertical range

                    document.body.appendChild(firework);

                    setTimeout(() => {
                        if (document.body.contains(firework)) {
                            firework.remove();
                        }
                    }, 1200); // Matches fireworkExplode animation duration

                }, i * (window.innerWidth < 768 ? 80 : 60)); // Adjust timing based on device
            }
        }

        // Create confetti effect
        function createConfetti() {
             if (currentStage !== 'thankYou') return; // Only trigger on thank you page

             const numConfetti = window.innerWidth < 768 ? 80 : 150; // Fewer confetti on mobile

            for (let i = 0; i < numConfetti; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = '-5vh';
                    const hue = Math.random() * 60; // Gold/Orange range
                    const lightness = Math.random() * 20 + 50; // Avoid too dark/light
                    confetti.style.backgroundColor = `hsl(${hue}, 100%, ${lightness}%)`;
                    const size = Math.random() * 6 + 3; // Smaller confetti on mobile
                    confetti.style.width = confetti.style.height = `${size}px`;

                     const fallDuration = `${Math.random() * 3 + 2}s`;
                     const fallDelay = `${Math.random() * 2}s`;

                     confetti.style.animation = `confettiFall ${fallDuration} ease-out forwards, confettiSideways ${fallDuration} ease-in-out forwards`;
                     confetti.style.animationDelay = `${fallDelay}, ${fallDelay}`;


                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                     const randomXEnd = (Math.random() - 0.5) * (window.innerWidth < 768 ? 40 : 60); // Adjust horizontal spread
                     confetti.style.setProperty('--confetti-end-x', `${randomXEnd}vw`);


                    document.body.appendChild(confetti);

                    setTimeout(() => {
                        if (document.body.contains(confetti)) {
                            confetti.remove();
                        }
                    }, (parseFloat(fallDuration) + parseFloat(fallDelay)) * 1000 + 100); // Clean up after animation ends

                }, i * (window.innerWidth < 768 ? 60 : 40)); // Adjust timing based on device
            }
        }


        // Toggle shimmer effect on elements
        function toggleShimmer(element, add) {
            if (!element) return; // Check if element exists
            const existingShimmer = element.querySelector('.shimmer-after');

            if (add) {
                // Add shimmering class if not already present
                if (!element.classList.contains('shimmering')) {
                     element.classList.add('shimmering');
                     // Create shimmer span if it doesn't exist
                    if (!existingShimmer) {
                        const shimmerEffect = document.createElement('span');
                        shimmerEffect.className = 'shimmer-after';
                        element.appendChild(shimmerEffect);
                    }
                }
            } else {
                // Remove shimmering class and the shimmer span
                element.classList.remove('shimmering');
                if(existingShimmer) {
                    existingShimmer.remove();
                }
            }
        }


        // Stage 1: Open envelope
        function openEnvelope() {
            if (currentStage !== 'envelope') return;

            // Attempt to play music on the first user interaction (clicking the envelope)
            // This respects browser policies that block autoplay without user gesture.
            if (backgroundMusic && isMusicSourceValid && !isMusicPlaying) {
                 const playPromise = backgroundMusic.play();
                 if (playPromise !== undefined) {
                     playPromise.catch(error => {
                         console.warn("Music play prevented after click:", error);
                         // Music couldn't be played, maybe show a message or rely on manual control
                         // musicStatusTextEl.textContent = 'Tap Play Icon';
                     });
                 }
            }

            // Trigger fireworks effect
            createFireworks();

             // Add fade-out animation class to the envelope
             envelopeEl.classList.add('fade-out');

            // Wait for the fade-out animation to finish, then switch stage
            setTimeout(() => {
                envelopeEl.style.display = 'none'; // Hide the envelope
                 envelopeEl.classList.remove('fade-out'); // Remove class for next time
                 envelopeEl.style.animation = ''; // Remove pulse animation

                // Show the main invitation card
                showStage(mainCardEl, 'main');
            }, 500); // Duration should match the fadeOut animation duration

        }

        // Stage 2: Show RSVP page
        function showRsvp() {
            if (currentStage !== 'main') return; // Only proceed if currently on the main card

            hideStage(mainCardEl); // Hide the main card
            showStage(rsvpSectionEl, 'rsvp'); // Show the RSVP section
        }

        // Stage 3: Show Thank You page (Now called from RSVP stage)
        function showThankYou() {
            if (currentStage !== 'rsvp') return; // Only proceed if currently on the RSVP page

             hideStage(rsvpSectionEl); // Hide the RSVP page
            showStage(thankYouSectionEl, 'thankYou'); // Show the thank you section
             createConfetti(); // Trigger confetti effect
        }

        // Back navigation logic
        function goBack() {
            // Prevent going back from the initial envelope stage
            if (currentStage === 'envelope') return;

            if (currentStage === 'thankYou') {
                // If on thank you page, go back to RSVP
                hideStage(thankYouSectionEl);
                showStage(rsvpSectionEl, 'rsvp'); // Go back to RSVP
            } else if (currentStage === 'rsvp') {
                // If on RSVP page, go back to Main Card
                hideStage(rsvpSectionEl);
                showStage(mainCardEl, 'main'); // Go back to Main Card
            } else if (currentStage === 'main') {
                // If on main card, go back to envelope
                hideStage(mainCardEl);
                showStage(envelopeEl, 'envelope'); // Go back to Envelope
            }
        }

        // Helper to show a stage and update state/button visibility
        function showStage(stageElement, stageName) {
            // Hide all *other* stage elements with animation first
            // Selects all .stage elements AND the .envelope-container
            document.querySelectorAll('.stage, .envelope-container').forEach(el => {
                // Only hide elements that are currently displayed and are not the target
                if (el !== stageElement && el.style.display !== 'none') {
                     el.classList.add('fade-out');
                     // Wait for fade-out before setting display: none
                     setTimeout(() => {
                        el.style.display = 'none';
                        el.classList.remove('fade-out'); // Clean up class
                     }, 500); // Match fadeOut duration
                }
            });

            // Remove shimmer from titles on *any* previous stage before showing the new one
            toggleShimmer(mainTitleEl, false); // Shimmer for main title
            toggleShimmer(thankYouTitleEl, false); // Shimmer for thank you title
            // Note: No shimmer added to RSVP title in this implementation

            currentStage = stageName; // Update current stage state

            if (stageName === 'envelope') {
                // Special handling for the envelope stage
                envelopeEl.style.display = 'flex'; // Envelope is flex container
                 envelopeEl.classList.remove('fade-out'); // Ensure no lingering class
                 envelopeEl.style.animation = 'pulse-float 3s infinite ease-in-out'; // Restart animation

                contentWrapperEl.style.display = 'none'; // Hide the content wrapper
                backButtonEl.classList.add('hidden'); // Hide the back button

            } else {
                // Handling for stages within the content wrapper
                envelopeEl.style.display = 'none'; // Ensure envelope is hidden
                 envelopeEl.style.animation = ''; // Remove envelope animation

                contentWrapperEl.style.display = 'flex'; // Show the content wrapper (as flex)
                // contentWrapperEl.style.justifyContent = 'center'; // Keep centered vertically if content is short
                contentWrapperEl.style.justifyContent = 'flex-start'; // Align to top if content can scroll
                 contentWrapperEl.style.padding = (window.innerWidth < 768 ? '10px' : '20px'); // Apply padding based on device


                // Use requestAnimationFrame + setTimeout to ensure stage is displayed
                // and allows the browser a moment before triggering child element animations.
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        stageElement.style.display = 'block'; // Display the target stage (as block inside flex column)

                        // Scroll the content wrapper to the top when showing a new stage
                        contentWrapperEl.scrollTo({ top: 0, behavior: 'smooth' });


                        // Add shimmer after element is displayed and animated in (allowing some delay)
                        if (stageElement === mainCardEl) {
                             setTimeout(() => toggleShimmer(mainTitleEl, true), 1200); // Delay after stage fadeInScale + element delays
                         } else if (stageElement === thankYouSectionEl) {
                            setTimeout(() => toggleShimmer(thankYouTitleEl, true), 800); // Delay after stage fadeInScale + element delays
                        }
                        // Add shimmer for RSVP title if desired:
                        // else if (stageElement === rsvpSectionEl) {
                        //     setTimeout(() => toggleShimmer(stageElement.querySelector('.rsvp-title'), true), 500);
                        // }


                    }, 50); // Short delay to ensure display property is set

                });

                // Show the back button for stages within the content wrapper
                backButtonEl.classList.remove('hidden');
            }
        }

        // Helper to hide a stage with animation
        function hideStage(stageElement) {
             if (stageElement && stageElement.style.display !== 'none') {
                 stageElement.classList.add('fade-out');
                // Use setTimeout to fully hide the element after the animation completes
                setTimeout(() => {
                    stageElement.style.display = 'none';
                    stageElement.classList.remove('fade-out'); // Clean up class
                }, 500); // Matches fadeOut duration
             }
        }


        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.body.classList.add('loaded'); // Make body visible after DOM is ready

            createParticles(); // Start background particles

            // Ensure content wrapper and all stages *within* it are initially hidden
             contentWrapperEl.style.display = 'none';
             document.querySelectorAll('.stage').forEach(stage => stage.style.display = 'none');


            // Explicitly show the initial envelope stage using the showStage helper
            // This ensures it's the only one visible and its specific animations start.
            showStage(envelopeEl, 'envelope');
        });

    </script>
</body>
</html>
